// KleinManager Frontend Application
class KleinManager {
    constructor() {
        this.currentLang = localStorage.getItem('language') || 'en';
        this.currentSection = 'dashboard';
        this.viewMode = localStorage.getItem('viewMode') || 'grid'; // grid or list
        this.apiBase = '/api/v1';

        this.translations = {
            en: {
                'nav.dashboard': 'Dashboard',
                'nav.orders': 'Orders',
                'nav.tracking': 'DHL Tracking',
                'nav.statistics': 'Statistics',
                'dashboard.title': 'Dashboard',
                'dashboard.recentOrders': 'Recent Orders',
                'orders.title': 'Orders',
                'orders.addNew': 'Add New Order',
                'orders.searchPlaceholder': 'Search...',
                'orders.urlPlaceholder': 'Enter Kleinanzeigen URL...',
                'orders.allStatus': 'All Status',
                'tracking.title': 'DHL Tracking',
                'statistics.title': 'Statistics',
                'stats.total': 'Total Orders',
                'stats.transit': 'In Transit',
                'stats.value': 'Total Value',
                'stats.newSellers': 'New Sellers',
                'status.ordered': 'Ordered',
                'status.shipped': 'Shipped',
                'status.delivered': 'Delivered',
                'actions.addOrder': 'Add Order',
                'actions.save': 'Save',
                'actions.cancel': 'Cancel',
                'actions.refresh': 'Refresh',
                'actions.updateAll': 'Update All',
                'actions.edit': 'Edit',
                'actions.delete': 'Delete',
                'actions.addTracking': 'Add DHL No.',
                'actions.updateTracking': 'Update DHL',
                'actions.viewListing': 'View Listing',
                'actions.viewOrder': 'View Order',
                'loading.title': 'Loading...',
                'seller.new': 'New Seller',
                'seller.since': 'Since',
                'tracking.progress': 'Progress',
                'tracking.history': 'Tracking History',
                'tracking.lastUpdate': 'Last Update',
                'order.price': 'Price',
                'order.category': 'Category',
                'order.location': 'Location',
                'order.seller': 'Seller'
            },
            de: {
                'nav.dashboard': 'Übersicht',
                'nav.orders': 'Bestellungen',
                'nav.tracking': 'DHL Verfolgung',
                'nav.statistics': 'Statistiken',
                'dashboard.title': 'Übersicht',
                'dashboard.recentOrders': 'Neueste Bestellungen',
                'orders.title': 'Bestellungen',
                'orders.addNew': 'Neue Bestellung hinzufügen',
                'orders.searchPlaceholder': 'Suchen...',
                'orders.urlPlaceholder': 'Kleinanzeigen URL eingeben...',
                'orders.allStatus': 'Alle Status',
                'tracking.title': 'DHL Sendungsverfolgung',
                'statistics.title': 'Statistiken',
                'stats.total': 'Gesamt',
                'stats.transit': 'Unterwegs',
                'stats.value': 'Gesamtwert',
                'stats.newSellers': 'Neue Verkäufer',
                'status.ordered': 'Bestellt',
                'status.shipped': 'Versendet',
                'status.delivered': 'Zugestellt',
                'actions.addOrder': 'Bestellung hinzufügen',
                'actions.save': 'Speichern',
                'actions.cancel': 'Abbrechen',
                'actions.refresh': 'Aktualisieren',
                'actions.updateAll': 'Alle aktualisieren',
                'actions.edit': 'Bearbeiten',
                'actions.delete': 'Löschen',
                'actions.addTracking': 'DHL Nr. hinzufügen',
                'actions.updateTracking': 'DHL Update',
                'actions.viewListing': 'Anzeige öffnen',
                'actions.viewOrder': 'Bestellung anzeigen',
                'loading.title': 'Lädt...',
                'seller.new': 'Neuer Verkäufer',
                'seller.since': 'Seit',
                'tracking.progress': 'Fortschritt',
                'tracking.history': 'Sendungsverlauf',
                'tracking.lastUpdate': 'Letztes Update',
                'order.price': 'Preis',
                'order.category': 'Kategorie',
                'order.location': 'Ort',
                'order.seller': 'Verkäufer'
            }
        };

        this.init();
    }

    init() {
        // Apply translations
        this.updateTranslations();

        // Update view mode icon
        this.updateViewIcon();

        // Load initial data
        this.loadDashboard();
    }

    // Language Management
    toggleLanguage() {
        this.currentLang = this.currentLang === 'en' ? 'de' : 'en';
        localStorage.setItem('language', this.currentLang);
        document.getElementById('currentLang').textContent = this.currentLang.toUpperCase();
        this.updateTranslations();
    }

    updateTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (this.translations[this.currentLang][key]) {
                element.textContent = this.translations[this.currentLang][key];
            }
        });

        document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
            const key = element.getAttribute('data-i18n-placeholder');
            if (this.translations[this.currentLang][key]) {
                element.placeholder = this.translations[this.currentLang][key];
            }
        });
    }

    t(key) {
        return this.translations[this.currentLang][key] || key;
    }

    // View Mode Management
    toggleView() {
        this.viewMode = this.viewMode === 'grid' ? 'list' : 'grid';
        localStorage.setItem('viewMode', this.viewMode);
        this.updateViewIcon();
        this.loadOrders();
    }

    updateViewIcon() {
        const icon = document.getElementById('viewToggleIcon');
        if (icon) {
            icon.className = this.viewMode === 'grid' ? 'fas fa-list' : 'fas fa-th';
        }
    }

    // Navigation
    showSection(section) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById(section).classList.remove('hidden');

        document.querySelectorAll('.nav-item').forEach(n => {
            n.classList.remove('active', 'bg-blue-900/50', 'border-l-4', 'border-blue-500');
        });
        event.target.closest('.nav-item').classList.add('active', 'bg-blue-900/50', 'border-l-4', 'border-blue-500');

        this.currentSection = section;

        // Load section data
        if (section === 'dashboard') this.loadDashboard();
        else if (section === 'orders') this.loadOrders();
        else if (section === 'tracking') this.loadTracking();
        else if (section === 'statistics') this.loadStatistics();
    }

    // Add Order Form Management
    showAddOrderForm() {
        document.getElementById('addOrderForm').classList.remove('hidden');
        document.getElementById('orderUrl').focus();
    }

    hideAddOrderForm() {
        document.getElementById('addOrderForm').classList.add('hidden');
        document.getElementById('orderUrl').value = '';
    }

    // UI Helpers
    showLoading(text) {
        document.getElementById('loadingText').textContent = text;
        document.getElementById('loadingOverlay').classList.remove('hidden');
        document.getElementById('loadingOverlay').classList.add('flex');
    }

    hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('loadingOverlay').classList.remove('flex');
    }

    showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const content = document.getElementById('toastContent');
        const icon = document.getElementById('toastIcon');
        const text = document.getElementById('toastText');

        text.textContent = message;

        if (type === 'success') {
            content.className = 'px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] bg-green-500 text-white';
            icon.className = 'fas fa-check-circle text-xl';
        } else if (type === 'error') {
            content.className = 'px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] bg-red-500 text-white';
            icon.className = 'fas fa-exclamation-circle text-xl';
        } else if (type === 'warning') {
            content.className = 'px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] bg-yellow-500 text-white';
            icon.className = 'fas fa-exclamation-triangle text-xl';
        }

        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 5000);
    }

    // API Calls
    async apiRequest(endpoint, options = {}) {
        try {
            const response = await fetch(`${this.apiBase}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Request failed');
            }

            return await response.json();
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }

    // Dashboard
    async loadDashboard() {
        try {
            const stats = await this.apiRequest('/stats');
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-transit').textContent = stats.transit;
            document.getElementById('stat-value').textContent = `€${stats.value}`;
            document.getElementById('stat-new-sellers').textContent = stats.new_sellers;

            const orders = await this.apiRequest('/orders?limit=6');
            const container = document.getElementById('recent-orders');
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-box-open text-gray-600 text-4xl mb-4"></i>
                        <p class="text-gray-400">No orders yet</p>
                    </div>
                `;
            } else {
                container.innerHTML = orders.map(order => this.renderOrderCard(order)).join('');
            }
        } catch (error) {
            this.showToast('Failed to load dashboard', 'error');
        }
    }

    // Orders
    async loadOrders() {
        try {
            const search = document.getElementById('searchInput')?.value || '';
            const status = document.getElementById('statusFilter')?.value || '';

            let url = '/orders?';
            if (search) url += `search=${encodeURIComponent(search)}&`;
            if (status) url += `status=${encodeURIComponent(status)}&`;

            const orders = await this.apiRequest(url);
            const container = document.getElementById('orders-list');

            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-box-open text-gray-600 text-4xl mb-4"></i>
                        <p class="text-gray-400">No orders found</p>
                    </div>
                `;
            } else {
                if (this.viewMode === 'grid') {
                    container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                    container.innerHTML = orders.map(order => this.renderOrderCard(order)).join('');
                } else {
                    container.className = 'space-y-4';
                    container.innerHTML = orders.map(order => this.renderOrderListItem(order)).join('');
                }
            }
        } catch (error) {
            this.showToast('Failed to load orders', 'error');
        }
    }

    // Add Order
    async addOrder(event) {
        event.preventDefault();
        const url = document.getElementById('orderUrl').value;

        this.showLoading(this.t('loading.title'));

        try {
            const order = await this.apiRequest('/orders', {
                method: 'POST',
                body: JSON.stringify({ url })
            });

            this.hideLoading();

            if (order.seller_is_new) {
                this.showToast(`⚠️ ${this.t('seller.new')}: ${order.seller_name} (${this.t('seller.since')} ${order.seller_since})`, 'warning');
            } else {
                this.showToast('Order added successfully', 'success');
            }

            this.hideAddOrderForm();
            this.loadOrders();
        } catch (error) {
            this.hideLoading();
            this.showToast(error.message, 'error');
        }
    }

    // Tracking
    async loadTracking() {
        try {
            const orders = await this.apiRequest('/orders/tracking');
            const container = document.getElementById('tracking-list');

            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-truck text-gray-600 text-4xl mb-4"></i>
                        <p class="text-gray-400">No active shipments</p>
                    </div>
                `;
            } else {
                container.innerHTML = orders.map(order => this.renderTrackingCard(order)).join('');
            }
        } catch (error) {
            this.showToast('Failed to load tracking', 'error');
        }
    }

    async updateAllTracking() {
        this.showLoading('Updating all tracking information...');

        try {
            const result = await this.apiRequest('/tracking/update-all', { method: 'POST' });
            this.hideLoading();
            this.showToast(`Updated ${result.updated} shipments`, 'success');

            if (this.currentSection === 'tracking') {
                this.loadTracking();
            }
        } catch (error) {
            this.hideLoading();
            this.showToast('Failed to update tracking', 'error');
        }
    }

    // Statistics
    async loadStatistics() {
        try {
            const stats = await this.apiRequest('/stats/detail');
            document.getElementById('stats-content').innerHTML = this.renderStatistics(stats);
        } catch (error) {
            this.showToast('Failed to load statistics', 'error');
        }
    }

    // Go to Order from Tracking
    goToOrder(orderId) {
        this.showSection('orders');
        // Highlight the order briefly
        setTimeout(() => {
            const orderElement = document.querySelector(`[data-order-id="${orderId}"]`);
            if (orderElement) {
                orderElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                orderElement.classList.add('ring-2', 'ring-blue-500');
                setTimeout(() => {
                    orderElement.classList.remove('ring-2', 'ring-blue-500');
                }, 3000);
            }
        }, 500);
    }

    // Render Functions - Card View
    renderOrderCard(order) {
        const images = order.local_images ? JSON.parse(order.local_images) : [];
        const dhlDetails = order.dhl_details ? JSON.parse(order.dhl_details) : null;

        return `
            <div class="bg-gray-800 rounded-xl shadow-sm border border-gray-700 hover:border-gray-600 transition-all hover:shadow-lg" data-order-id="${order.id}">
                <div class="relative">
                    ${images.length > 0
                        ? `<img src="/images/${images[0]}" class="w-full h-48 object-cover rounded-t-xl cursor-pointer" onclick="window.open('/images/${images[0]}', '_blank')">`
                        : `<div class="w-full h-48 bg-gray-700 rounded-t-xl flex items-center justify-center">
                             <i class="fas fa-image text-gray-500 text-3xl"></i>
                           </div>`
                    }
                    <span class="absolute top-2 right-2 px-2 py-1 rounded-lg text-xs font-medium ${this.getStatusClass(order.status)}">
                        ${this.t(`status.${order.status.toLowerCase()}`)}
                    </span>
                </div>

                <div class="p-4">
                    <h3 class="text-lg font-semibold text-white mb-2 line-clamp-2">${order.title}</h3>
                    <p class="text-2xl font-bold text-blue-400 mb-3">€${order.price.toFixed(2)}</p>

                    <div class="space-y-2 text-sm text-gray-400 mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-tag mr-2 w-4"></i>
                            <span class="truncate">${order.category || 'N/A'}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 w-4"></i>
                            <span class="truncate">${order.location || 'N/A'}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-user mr-2 w-4"></i>
                            <span class="truncate">${order.seller_name || 'N/A'}</span>
                        </div>
                    </div>

                    ${order.seller_is_new ? `
                        <div class="mb-3 px-2 py-1 bg-red-900/50 text-red-300 rounded text-xs text-center">
                            ⚠️ ${this.t('seller.new')}
                        </div>
                    ` : ''}

                    ${order.tracking_number && dhlDetails && !dhlDetails.error ? `
                        <div class="mb-3 p-2 bg-blue-900/30 border border-blue-700 rounded">
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-blue-300">
                                    <i class="fas fa-truck mr-1"></i>DHL
                                </span>
                                <span class="text-blue-400">${dhlDetails.progress || 0}%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-1 mt-1">
                                <div class="bg-blue-500 h-1 rounded-full" style="width: ${dhlDetails.progress || 0}%"></div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="flex flex-wrap gap-2">
                        ${!order.tracking_number ? `
                            <button onclick="app.addTracking(${order.id})" class="flex-1 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-xs transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        ` : `
                            <button onclick="app.updateTracking(${order.id})" class="flex-1 px-3 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-xs transition-colors">
                                <i class="fas fa-sync"></i>
                            </button>
                        `}
                        <a href="${order.article_url}" target="_blank" class="flex-1 px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-xs text-center transition-colors">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                        <button onclick="app.deleteOrder(${order.id})" class="flex-1 px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-xs transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Render Functions - List View
    renderOrderListItem(order) {
        const images = order.local_images ? JSON.parse(order.local_images) : [];
        const dhlDetails = order.dhl_details ? JSON.parse(order.dhl_details) : null;

        return `
            <div class="bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-700 hover:border-gray-600 transition-all" data-order-id="${order.id}">
                <div class="flex gap-4">
                    <div class="w-20 h-20 flex-shrink-0">
                        ${images.length > 0
                            ? `<img src="/images/${images[0]}" class="w-full h-full object-cover rounded-lg cursor-pointer" onclick="window.open('/images/${images[0]}', '_blank')">`
                            : `<div class="w-full h-full bg-gray-700 rounded-lg flex items-center justify-center">
                                 <i class="fas fa-image text-gray-500"></i>
                               </div>`
                        }
                    </div>

                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold text-white truncate">${order.title}</h3>
                            <span class="px-2 py-1 rounded text-xs font-medium ${this.getStatusClass(order.status)} ml-2">
                                ${this.t(`status.${order.status.toLowerCase()}`)}
                            </span>
                        </div>

                        <div class="flex items-center gap-4 text-sm text-gray-400 mb-2">
                            <span class="text-xl font-bold text-blue-400">€${order.price.toFixed(2)}</span>
                            <span><i class="fas fa-tag mr-1"></i>${order.category || 'N/A'}</span>
                            <span><i class="fas fa-map-marker-alt mr-1"></i>${order.location || 'N/A'}</span>
                            <span><i class="fas fa-user mr-1"></i>${order.seller_name || 'N/A'}</span>
                        </div>

                        ${order.tracking_number && dhlDetails && !dhlDetails.error ? `
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs text-blue-300"><i class="fas fa-truck mr-1"></i>DHL ${order.tracking_number}</span>
                                <div class="flex-1 max-w-xs">
                                    <div class="w-full bg-gray-700 rounded-full h-1">
                                        <div class="bg-blue-500 h-1 rounded-full" style="width: ${dhlDetails.progress || 0}%"></div>
                                    </div>
                                </div>
                                <span class="text-xs text-blue-400">${dhlDetails.progress || 0}%</span>
                            </div>
                        ` : ''}

                        <div class="flex gap-2">
                            ${!order.tracking_number ? `
                                <button onclick="app.addTracking(${order.id})" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs transition-colors">
                                    <i class="fas fa-plus mr-1"></i>DHL
                                </button>
                            ` : `
                                <button onclick="app.updateTracking(${order.id})" class="px-3 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-xs transition-colors">
                                    <i class="fas fa-sync mr-1"></i>Update
                                </button>
                            `}
                            <a href="${order.article_url}" target="_blank" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-xs transition-colors">
                                <i class="fas fa-external-link-alt mr-1"></i>View
                            </a>
                            <button onclick="app.deleteOrder(${order.id})" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs transition-colors">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Tracking Card with link to order
    renderTrackingCard(order) {
        const dhlDetails = order.dhl_details ? JSON.parse(order.dhl_details) : null;
        if (!dhlDetails || dhlDetails.error) {
            return '';
        }

        return `
            <div class="bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-700">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-semibold text-white mb-1">${order.title}</h3>
                        <p class="text-gray-400">
                            <i class="fas fa-truck mr-2"></i>DHL ${order.tracking_number}
                        </p>
                    </div>
                    <span class="px-3 py-1 bg-blue-900/50 text-blue-300 rounded-lg text-sm font-medium">
                        ${dhlDetails.status}
                    </span>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm text-gray-400">${this.t('tracking.progress')}</p>
                        <span class="text-sm font-medium text-blue-400">${dhlDetails.progress || 0}%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3">
                        <div class="bg-blue-500 h-3 rounded-full" style="width: ${dhlDetails.progress || 0}%"></div>
                    </div>
                </div>

                ${dhlDetails.history && dhlDetails.history.length > 0 ? `
                    <div class="mb-4">
                        <h4 class="font-medium text-white mb-3">${this.t('tracking.history')}</h4>
                        <div class="space-y-3 max-h-60 overflow-y-auto">
                            ${dhlDetails.history.slice(0, 3).map((event, index) => `
                                <div class="flex items-start gap-3 ${index === 0 ? 'text-blue-400' : 'text-gray-400'}">
                                    <div class="w-2 h-2 rounded-full ${index === 0 ? 'bg-blue-500' : 'bg-gray-600'} mt-2 flex-shrink-0"></div>
                                    <div class="flex-1">
                                        <p class="text-xs font-medium">${event.time}</p>
                                        <p class="text-sm">${event.text}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <div class="flex gap-2">
                    <button onclick="app.goToOrder(${order.id})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm transition-colors">
                        <i class="fas fa-box mr-2"></i>${this.t('actions.viewOrder')}
                    </button>
                    <button onclick="app.updateTracking(${order.id})" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm transition-colors">
                        <i class="fas fa-sync mr-2"></i>${this.t('actions.refresh')}
                    </button>
                    <a href="${dhlDetails.url}" target="_blank" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm transition-colors">
                        <i class="fas fa-external-link-alt mr-2"></i>DHL
                    </a>
                </div>
            </div>
        `;
    }

    renderStatistics(stats) {
        return `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-700">
                    <h3 class="text-lg font-semibold text-white mb-6">By Status</h3>
                    <div class="space-y-4">
                        ${Object.entries(stats.by_status || {}).map(([status, count]) => `
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-400">${this.t(`status.${status.toLowerCase()}`)}</span>
                                <span class="font-semibold text-white text-lg">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-700">
                    <h3 class="text-lg font-semibold text-white mb-6">Top Categories</h3>
                    <div class="space-y-4">
                        ${(stats.top_categories || []).map(cat => `
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-400">${cat.category}</span>
                                <span class="font-semibold text-white text-lg">${cat.count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    getStatusClass(status) {
        const classes = {
            'Ordered': 'bg-gray-700 text-gray-300',
            'Shipped': 'bg-blue-700 text-blue-200',
            'Delivered': 'bg-green-700 text-green-200'
        };
        return classes[status] || classes['Ordered'];
    }

    // Order Actions
    async deleteOrder(id) {
        if (!confirm('Really delete this order?')) return;

        try {
            await this.apiRequest(`/orders/${id}`, { method: 'DELETE' });
            this.showToast('Order deleted successfully', 'success');

            if (this.currentSection === 'dashboard') this.loadDashboard();
            else if (this.currentSection === 'orders') this.loadOrders();
        } catch (error) {
            this.showToast('Failed to delete order', 'error');
        }
    }

    async addTracking(id) {
        const trackingNumber = prompt('Enter DHL tracking number:');
        if (!trackingNumber) return;

        try {
            await this.apiRequest(`/orders/${id}`, {
                method: 'PUT',
                body: JSON.stringify({ tracking_number: trackingNumber })
            });
            this.showToast('Tracking number added', 'success');

            if (this.currentSection === 'dashboard') this.loadDashboard();
            else if (this.currentSection === 'orders') this.loadOrders();
        } catch (error) {
            this.showToast('Failed to add tracking number', 'error');
        }
    }

    async updateTracking(id) {
        this.showLoading('Updating tracking information...');

        try {
            await this.apiRequest(`/orders/${id}/tracking`, { method: 'POST' });
            this.hideLoading();
            this.showToast('Tracking updated', 'success');

            if (this.currentSection === 'dashboard') this.loadDashboard();
            else if (this.currentSection === 'orders') this.loadOrders();
            else if (this.currentSection === 'tracking') this.loadTracking();
        } catch (error) {
            this.hideLoading();
            this.showToast('Failed to update tracking', 'error');
        }
    }
}

// Initialize application
const app = new KleinManager();